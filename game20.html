<!DOCTYPE html>
<html>
<head>
    <title>AR Seismic Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <style>
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        #infoPanel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            z-index: 1001;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- AR Scene -->
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;'>
        <!-- Camera -->
        <a-entity camera></a-entity>
        
        <!-- AR Seismic Model -->
        <a-entity id="seismicModel" visible="false">
            <a-box position="0 0.5 -1" 
                   rotation="0 45 0" 
                   scale="1 0.2 1" 
                   material="color: #4B0082">
            </a-box>
        </a-entity>
    </a-scene>

    <!-- UI Overlay -->
    <div class="ui-overlay">
        <div id="infoPanel">Loading model...</div>
    </div>

    <!-- TensorFlow.js -->
    <script>
        let classifier; // KNN Classifier
        let net;        // MobileNet Model
        let video;      // Camera Input
        let isDetecting = false;

        const seismicModel = document.getElementById('seismicModel');
        const infoPanel = document.getElementById('infoPanel');

        async function loadModel() {
            infoPanel.textContent = 'Loading model...';

            // Load MobileNet and KNN Classifier
            net = await mobilenet.load();
            classifier = knnClassifier.create();

            // Train using seismic_texture.jpg
            const image = document.createElement('img');
            image.src = 'seismic_texture.jpg';
            await new Promise(resolve => (image.onload = resolve));

            const logits = net.infer(image, 'conv_preds'); // Extract features
            classifier.addExample(logits, 0); // Label '0' = Seismic Section

            infoPanel.textContent = 'Model loaded. Point camera at seismic section!';
        }

        async function setupCamera() {
            video = document.createElement('video');
            video.width = 224;
            video.height = 224;

            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });

            video.srcObject = stream;
            await new Promise(resolve => (video.onloadedmetadata = resolve));
            video.play();
        }

        async function detectSeismic() {
            const img = tf.browser.fromPixels(video);
            const logits = net.infer(img, 'conv_preds'); // Extract features
            const result = await classifier.predictClass(logits);

            if (result.label === '0') {
                infoPanel.textContent = 'Seismic Section Detected!';
                seismicModel.setAttribute('visible', 'true');
            } else {
                infoPanel.textContent = 'No seismic section detected.';
                seismicModel.setAttribute('visible', 'false');
            }

            img.dispose(); // Free up memory

            if (isDetecting) {
                requestAnimationFrame(detectSeismic);
            }
        }

        async function startDetection() {
            isDetecting = true;
            await detectSeismic();
        }

        async function initAR() {
            try {
                await loadModel();
                await setupCamera();
                startDetection();
            } catch (error) {
                console.error('Initialization Error:', error);
                infoPanel.textContent = 'Initialization failed. Please refresh.';
            }
        }

        window.addEventListener('DOMContentLoaded', initAR);
    </script>
</body>
</html>