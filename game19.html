<!DOCTYPE html>
<html>
<head>
    <title>Mobile Geology AR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Using specific mobile-compatible versions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.0.8/aframe-ar-nft.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
            user-select: none;
        }

        .ui-button {
            position: fixed;
            z-index: 999999;
            padding: 1rem;
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 10px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        #startButton {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
        }

        #infoBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 999999;
            width: 80%;
            max-width: 300px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }

        .geology-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 999999;
            display: none;
            width: 80%;
            max-width: 300px;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }

        /* iOS-specific styles */
        @supports (-webkit-touch-callout: none) {
            .ui-button {
                padding: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- AR Scene with minimal configuration -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;" renderer="antialias: true; alpha: true" vr-mode-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <!-- Simple AR marker -->
        <a-box id="rock-model" 
               position="0 0.5 -1" 
               rotation="0 45 0" 
               scale="0.5 0.5 0.5" 
               material="color: #8B4513"
               visible="false">
        </a-box>
    </a-scene>

    <!-- Mobile-optimized UI -->
    <div id="infoBox">Point your camera at a surface</div>
    <button id="startButton" class="ui-button" onclick="startAR()">Start Camera</button>

    <!-- Geology Information Panel -->
    <div id="geologyInfo" class="geology-info">
        <h3 style="margin-top: 0;">Geological Feature Found!</h3>
        <p>Type: Sedimentary Rock<br>
           Age: 150 million years<br>
           Composition: Limestone</p>
    </div>

    <script>
        let isStarted = false;
        const startButton = document.getElementById('startButton');
        const infoBox = document.getElementById('infoBox');
        const geologyInfo = document.getElementById('geologyInfo');
        const rockModel = document.getElementById('rock-model');

        // Prevent default touch behaviors
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Handle iOS permissions
        function requestIOSPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            enableAR();
                        } else {
                            infoBox.textContent = 'Permission needed for AR';
                        }
                    })
                    .catch(console.error);
            } else {
                enableAR();
            }
        }

        function startAR() {
            if (!isStarted) {
                requestIOSPermission();
            } else {
                resetAR();
            }
        }

        function enableAR() {
            isStarted = true;
            startButton.textContent = 'Reset AR';
            infoBox.textContent = 'Scanning for geological features...';
            rockModel.setAttribute('visible', 'true');
            
            // Simulate feature detection after a delay
            setTimeout(() => {
                if (isStarted) {
                    geologyInfo.style.display = 'block';
                    infoBox.textContent = 'Feature detected!';
                }
            }, 2000);
        }

        function resetAR() {
            isStarted = false;
            startButton.textContent = 'Start Camera';
            infoBox.textContent = 'Point your camera at a surface';
            geologyInfo.style.display = 'none';
            rockModel.setAttribute('visible', 'false');
        }

        // Handle camera errors
        window.addEventListener('camera-error', function() {
            infoBox.textContent = 'Camera error - please refresh';
            startButton.disabled = true;
        });

        // Initialize camera when ready
        window.addEventListener('camera-init', function() {
            infoBox.textContent = 'Camera ready - tap Start';
            startButton.disabled = false;
        });

        // Ensure proper cleanup
        window.addEventListener('beforeunload', function() {
            if (isStarted) {
                resetAR();
            }
        });
    </script>
</body>
</html>